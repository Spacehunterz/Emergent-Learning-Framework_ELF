#!/bin/bash
#
# Pre-commit hook: Auto-improve code with Ralph loop
#
# Runs Code Reviewer ‚Üí Code Simplifier on staged changes
# before allowing commit
#
# Set SKIP_RALPH_LOOP=1 to bypass, or use:
#   git commit --no-verify
#

set -e

# Allow opting out
if [ "$SKIP_RALPH_LOOP" = "1" ]; then
    exit 0
fi

# Get the project root
REPO_ROOT=$(git rev-parse --show-toplevel)
PYTHON_CMD=$(command -v python3 || command -v python)

if [ -z "$PYTHON_CMD" ]; then
    echo "‚ö†Ô∏è  Python not found - skipping Ralph loop"
    exit 0
fi

# Get staged files (only review these, not entire repo)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "üîÑ Ralph Loop: Auto-improving staged code..."
echo ""

# Filter to code files only (*.ts, *.tsx, *.js, *.jsx, *.py, *.go, etc)
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|py|go|java|rs|rb|php|cs|cpp|c|h|swift|kt)$' || true)

if [ -z "$CODE_FILES" ]; then
    # No code files, skip Ralph
    exit 0
fi

RALPH_SCRIPT="$REPO_ROOT/src/query/ralph_orchestrator.py"

if [ ! -f "$RALPH_SCRIPT" ]; then
    echo "‚ö†Ô∏è  Ralph orchestrator not found - skipping"
    exit 0
fi

# Process each staged code file through Ralph loop
SUCCESS=true
for file in $CODE_FILES; do
    if [ -f "$REPO_ROOT/$file" ]; then
        echo "  Reviewing: $file"

        # Run Ralph loop with 2 iterations max (pre-commit, so keep it fast)
        if $PYTHON_CMD "$RALPH_SCRIPT" --target "$REPO_ROOT/$file" --max-iterations 2 2>&1 | grep -q "RALPH LOOP COMPLETE"; then
            echo "    ‚úì Improved"
        else
            echo "    ‚ÑπÔ∏è  No changes needed"
        fi
    fi
done

# Check if any files were modified by Ralph
if git diff --quiet; then
    echo ""
    echo "‚úì All code reviewed and improved"
    exit 0
else
    echo ""
    echo "‚ö†Ô∏è  Files were improved by Ralph loop"
    echo "   Stage the improvements and try committing again:"
    echo ""
    echo "   git add ."
    echo "   git commit"
    echo ""
    echo "   Or skip Ralph with:"
    echo "   SKIP_RALPH_LOOP=1 git commit -m 'message'"
    exit 1
fi
